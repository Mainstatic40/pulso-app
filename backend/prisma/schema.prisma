generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  supervisor
  becario
}

enum TaskStatus {
  pending
  in_progress
  review
  completed
}

enum TaskPriority {
  high
  medium
  low
}

enum EquipmentCategory {
  camera
  lens
  adapter
  sd_card
}

enum EquipmentStatus {
  available
  in_use
  maintenance
}

enum EventType {
  civic
  church
  yearbook
  congress
}

model User {
  id           String   @id @default(uuid())
  name         String   @db.VarChar(100)
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  rfidTag      String?  @unique @map("rfid_tag") @db.VarChar(50)
  profileImage String?  @map("profile_image") @db.VarChar(255)
  role         UserRole @default(becario)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  timeEntries              TimeEntry[]
  createdTasks             Task[]                      @relation("TaskCreator")
  assignedTasks            TaskAssignee[]
  createdEvents            Event[]                     @relation("EventCreator")
  assignedEvents           EventAssignee[]
  eventShifts              EventShift[]
  comments                 Comment[]
  weeklyLogs               WeeklyLog[]
  equipmentAssignments     EquipmentAssignment[]       @relation("EquipmentUser")
  createdAssignments       EquipmentAssignment[]       @relation("AssignmentCreator")
  monthlyHoursConfigs      MonthlyHoursConfig[]
  attachments              Attachment[]
  conversationParticipants ConversationParticipant[]
  messages                 Message[]
  notifications            Notification[]
  equipmentUsageLogs       EquipmentUsageLog[]

  @@index([role])
  @@index([isActive])
  @@map("users")
}

model TimeEntry {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  eventId    String?   @map("event_id")
  clockIn    DateTime  @map("clock_in")
  clockOut   DateTime? @map("clock_out")
  totalHours Decimal?  @map("total_hours") @db.Decimal(5, 2)
  createdAt  DateTime  @default(now()) @map("created_at")

  user  User   @relation(fields: [userId], references: [id])
  event Event? @relation(fields: [eventId], references: [id])

  @@index([userId])
  @@index([eventId])
  @@index([clockIn])
  @@map("time_entries")
}

model Task {
  id                 String       @id @default(uuid())
  title              String       @db.VarChar(200)
  description        String       @db.Text
  clientRequirements String?      @map("client_requirements") @db.Text
  status             TaskStatus   @default(pending)
  priority           TaskPriority @default(medium)
  dueDate            DateTime     @map("due_date") @db.Date
  executionDate      DateTime?    @map("execution_date") @db.Date
  shift              String?      @db.VarChar(20)
  morningStartTime   String?      @map("morning_start_time") @db.VarChar(5)
  morningEndTime     String?      @map("morning_end_time") @db.VarChar(5)
  afternoonStartTime String?      @map("afternoon_start_time") @db.VarChar(5)
  afternoonEndTime   String?      @map("afternoon_end_time") @db.VarChar(5)
  createdBy          String       @map("created_by")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")

  creator        User                @relation("TaskCreator", fields: [createdBy], references: [id])
  assignees      TaskAssignee[]
  comments       Comment[]
  checklistItems TaskChecklistItem[]
  attachments    Attachment[]

  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([executionDate])
  @@index([createdBy])
  @@map("tasks")
}

model TaskAssignee {
  taskId     String   @map("task_id")
  userId     String   @map("user_id")
  assignedAt DateTime @default(now()) @map("assigned_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([taskId, userId])
  @@map("task_assignees")
}

model TaskChecklistItem {
  id          String   @id @default(uuid())
  taskId      String   @map("task_id")
  content     String   @db.VarChar(500)
  isCompleted Boolean  @default(false) @map("is_completed")
  order       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@map("task_checklist_items")
}

model Event {
  id                 String    @id @default(uuid())
  name               String    @db.VarChar(200)
  description        String    @db.Text
  clientRequirements String?   @map("client_requirements") @db.Text
  eventType          EventType @map("event_type")
  startDatetime      DateTime  @map("start_datetime")
  endDatetime        DateTime  @map("end_datetime")
  // Preset times for yearbook events
  morningStartTime   String?   @map("morning_start_time") @db.VarChar(5)
  morningEndTime     String?   @map("morning_end_time") @db.VarChar(5)
  afternoonStartTime String?   @map("afternoon_start_time") @db.VarChar(5)
  afternoonEndTime   String?   @map("afternoon_end_time") @db.VarChar(5)
  usePresetEquipment Boolean   @default(false) @map("use_preset_equipment")
  createdBy          String    @map("created_by")
  createdAt          DateTime  @default(now()) @map("created_at")

  creator              User                  @relation("EventCreator", fields: [createdBy], references: [id])
  assignees            EventAssignee[]
  timeEntries          TimeEntry[]
  equipmentAssignments EquipmentAssignment[]
  days                 EventDay[]
  attachments          Attachment[]
  eventRequests        EventRequest[]
  comments             Comment[]
  checklistItems       EventChecklistItem[]

  @@index([eventType])
  @@index([startDatetime])
  @@index([endDatetime])
  @@index([createdBy])
  @@map("events")
}

model EventAssignee {
  eventId String @map("event_id")
  userId  String @map("user_id")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([eventId, userId])
  @@map("event_assignees")
}

model EventDay {
  id        String   @id @default(uuid())
  eventId   String   @map("event_id")
  date      DateTime @db.Date
  note      String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  event  Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  shifts EventShift[]

  @@unique([eventId, date])
  @@index([eventId])
  @@index([date])
  @@map("event_days")
}

model EventShift {
  id         String   @id @default(uuid())
  eventDayId String   @map("event_day_id")
  userId     String   @map("user_id")
  startTime  String   @map("start_time") @db.VarChar(5)
  endTime    String   @map("end_time") @db.VarChar(5)
  shiftType  String?  @map("shift_type") @db.VarChar(20)
  note       String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  eventDay             EventDay              @relation(fields: [eventDayId], references: [id], onDelete: Cascade)
  user                 User                  @relation(fields: [userId], references: [id])
  equipmentAssignments EquipmentAssignment[]

  @@index([eventDayId])
  @@index([userId])
  @@map("event_shifts")
}

model Comment {
  id        String   @id @default(uuid())
  taskId    String?  @map("task_id")
  eventId   String?  @map("event_id")
  userId    String   @map("user_id")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  task  Task?  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  event Event? @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User   @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([eventId])
  @@index([userId])
  @@map("comments")
}

model EventChecklistItem {
  id          String   @id @default(uuid())
  eventId     String   @map("event_id")
  content     String   @db.VarChar(500)
  isCompleted Boolean  @default(false) @map("is_completed")
  order       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("event_checklist_items")
}

model WeeklyLog {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  weekStart    DateTime @map("week_start") @db.Date
  weekEnd      DateTime @map("week_end") @db.Date
  activities   String   @db.Text
  achievements String?  @db.Text
  challenges   String?  @db.Text
  learnings    String?  @db.Text
  nextGoals    String?  @map("next_goals") @db.Text
  totalHours   Decimal  @map("total_hours") @db.Decimal(5, 2)
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, weekStart])
  @@index([userId])
  @@index([weekStart])
  @@map("weekly_logs")
}

model Equipment {
  id           String            @id @default(uuid())
  name         String            @db.VarChar(200)
  category     EquipmentCategory
  status       EquipmentStatus   @default(available)
  description  String?           @db.Text
  serialNumber String?           @map("serial_number") @db.VarChar(100)
  rfidTag      String?           @unique @map("rfid_tag") @db.VarChar(50)
  isActive     Boolean           @default(true) @map("is_active")
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  assignments    EquipmentAssignment[]
  usageLogItems  EquipmentUsageLogItem[]

  @@index([category])
  @@index([status])
  @@index([isActive])
  @@map("equipment")
}

model EquipmentAssignment {
  id           String    @id @default(uuid())
  equipmentId  String    @map("equipment_id")
  userId       String    @map("user_id")
  eventId      String?   @map("event_id")
  eventShiftId String?   @map("event_shift_id")
  startTime    DateTime  @map("start_time")
  endTime      DateTime? @map("end_time")
  notes        String?   @db.Text
  createdBy    String    @map("created_by")
  createdAt    DateTime  @default(now()) @map("created_at")

  equipment  Equipment   @relation(fields: [equipmentId], references: [id])
  user       User        @relation("EquipmentUser", fields: [userId], references: [id])
  event      Event?      @relation(fields: [eventId], references: [id])
  eventShift EventShift? @relation(fields: [eventShiftId], references: [id])
  creator    User        @relation("AssignmentCreator", fields: [createdBy], references: [id])

  @@index([equipmentId])
  @@index([userId])
  @@index([eventId])
  @@index([eventShiftId])
  @@index([startTime])
  @@map("equipment_assignments")
}

model MonthlyHoursConfig {
  id          String    @id @default(uuid())
  year        Int
  month       Int       // 1-12
  targetHours Decimal   @map("target_hours") @db.Decimal(5, 2)
  hoursPerDay Decimal   @default(4) @map("hours_per_day") @db.Decimal(4, 2)
  startDate   DateTime? @map("start_date") @db.Date
  createdBy   String    @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  creator User @relation(fields: [createdBy], references: [id])

  @@unique([year, month])
  @@index([year])
  @@map("monthly_hours_config")
}

model Attachment {
  id         String   @id @default(uuid())
  filename   String   @db.VarChar(255)
  storedName String   @map("stored_name") @db.VarChar(255)
  mimeType   String   @map("mime_type") @db.VarChar(100)
  size       Int
  taskId     String?  @map("task_id")
  eventId    String?  @map("event_id")
  uploadedBy String   @map("uploaded_by")
  createdAt  DateTime @default(now()) @map("created_at")

  task     Task?     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  event    Event?    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  uploader User      @relation(fields: [uploadedBy], references: [id])
  messages Message[]

  @@index([taskId])
  @@index([eventId])
  @@map("attachments")
}

model Conversation {
  id        String   @id @default(uuid())
  name      String?  @db.VarChar(100)
  isGroup   Boolean  @default(false) @map("is_group")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

model ConversationParticipant {
  conversationId String    @map("conversation_id")
  userId         String    @map("user_id")
  joinedAt       DateTime  @default(now()) @map("joined_at")
  lastReadAt     DateTime? @map("last_read_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([conversationId, userId])
  @@map("conversation_participants")
}

model Message {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  senderId       String   @map("sender_id")
  content        String   @db.Text
  attachmentId   String?  @map("attachment_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id])
  attachment   Attachment?  @relation(fields: [attachmentId], references: [id])

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String   @db.VarChar(50)
  title     String   @db.VarChar(200)
  message   String   @db.Text
  link      String?  @db.VarChar(255)
  isRead    Boolean  @default(false) @map("is_read")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model PendingRfid {
  id        String   @id @default(uuid())
  rfidTag   String   @unique @map("rfid_tag") @db.VarChar(50)
  scannedAt DateTime @default(now()) @map("scanned_at")
  note      String?  @db.VarChar(255)

  @@index([scannedAt])
  @@map("pending_rfids")
}

model EquipmentUsageLog {
  id       String   @id @default(uuid())
  userId   String   @map("user_id")
  loggedAt DateTime @default(now()) @map("logged_at")

  user  User                    @relation(fields: [userId], references: [id])
  items EquipmentUsageLogItem[]

  @@index([userId])
  @@index([loggedAt])
  @@map("equipment_usage_logs")
}

model EquipmentUsageLogItem {
  id          String @id @default(uuid())
  logId       String @map("log_id")
  equipmentId String @map("equipment_id")

  log       EquipmentUsageLog @relation(fields: [logId], references: [id], onDelete: Cascade)
  equipment Equipment         @relation(fields: [equipmentId], references: [id])

  @@index([logId])
  @@index([equipmentId])
  @@map("equipment_usage_log_items")
}

// ============ SOLICITUDES DE EVENTOS ============

model EventRequestConfig {
  id         String   @id @default(uuid())
  accessCode String   @unique @map("access_code") @db.VarChar(50)
  isActive   Boolean  @default(true) @map("is_active")
  rateLimit  Int      @default(5) @map("rate_limit")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("event_request_config")
}

model SolicitorToken {
  id        String   @id @default(uuid())
  email     String   @unique
  token     String   @unique @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("solicitor_tokens")
}

model EventRequest {
  id                       String    @id @default(uuid())
  code                     String    @unique @db.VarChar(20)
  status                   String    @default("pending") @db.VarChar(20)
  // Organizaci√≥n
  tipoOrganizacion         String    @map("tipo_organizacion") @db.VarChar(20)
  facultad                 String?   @db.VarChar(50)
  facultadCarrera          String?   @map("facultad_carrera") @db.VarChar(100)
  departamentoNombre       String?   @map("departamento_nombre") @db.VarChar(200)
  // Solicitante
  solicitanteNombre        String    @map("solicitante_nombre") @db.VarChar(200)
  solicitanteCargo         String    @map("solicitante_cargo") @db.VarChar(50)
  solicitanteEmail         String    @map("solicitante_email") @db.VarChar(200)
  solicitanteTelefono      String    @map("solicitante_telefono") @db.VarChar(50)
  // Evento
  eventoNombre             String    @map("evento_nombre") @db.VarChar(300)
  eventoTipo               String    @map("evento_tipo") @db.VarChar(100)
  eventoTipoOtro           String?   @map("evento_tipo_otro") @db.VarChar(200)
  eventoFecha              DateTime  @map("evento_fecha")
  eventoHoraInicio         String    @map("evento_hora_inicio") @db.VarChar(10)
  eventoHoraFin            String    @map("evento_hora_fin") @db.VarChar(10)
  eventoUbicacion          String    @map("evento_ubicacion") @db.VarChar(300)
  eventoAsistentes         Int?      @map("evento_asistentes")
  // Servicios
  servicioFotografia       Boolean   @default(false) @map("servicio_fotografia")
  servicioVideo            Boolean   @default(false) @map("servicio_video")
  // Detalles
  descripcion              String?   @db.Text
  requerimientosEspeciales String?   @map("requerimientos_especiales") @db.Text
  notasInternas            String?   @map("notas_internas") @db.Text
  mensajeSolicitante       String?   @map("mensaje_solicitante") @db.Text
  eventId                  String?   @map("event_id")
  ipAddress                String?   @map("ip_address") @db.VarChar(50)
  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")
  respondedAt              DateTime? @map("responded_at")
  respondedBy              String?   @map("responded_by")

  event Event? @relation(fields: [eventId], references: [id])

  @@index([status])
  @@index([solicitanteEmail])
  @@index([createdAt])
  @@map("event_requests")
}

model TokenRecoveryRequest {
  id        String    @id @default(uuid())
  email     String    @db.VarChar(200)
  token     String?   @db.VarChar(50)
  status    String    @default("pending") @db.VarChar(20)
  createdAt DateTime  @default(now()) @map("created_at")
  sentAt    DateTime? @map("sent_at")

  @@index([status])
  @@index([createdAt])
  @@map("token_recovery_requests")
}
