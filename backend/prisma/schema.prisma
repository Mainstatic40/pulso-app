generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  supervisor
  becario
}

enum TaskStatus {
  pending
  in_progress
  review
  completed
}

enum TaskPriority {
  high
  medium
  low
}

model User {
  id           String   @id @default(uuid())
  name         String   @db.VarChar(100)
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  rfidTag      String?  @unique @map("rfid_tag") @db.VarChar(50)
  role         UserRole @default(becario)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  timeEntries    TimeEntry[]
  createdTasks   Task[]          @relation("TaskCreator")
  assignedTasks  TaskAssignee[]
  createdEvents  Event[]         @relation("EventCreator")
  assignedEvents EventAssignee[]
  comments       Comment[]
  weeklyLogs     WeeklyLog[]

  @@index([role])
  @@index([isActive])
  @@map("users")
}

model TimeEntry {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  eventId    String?   @map("event_id")
  clockIn    DateTime  @map("clock_in")
  clockOut   DateTime? @map("clock_out")
  totalHours Decimal?  @map("total_hours") @db.Decimal(5, 2)
  createdAt  DateTime  @default(now()) @map("created_at")

  user  User   @relation(fields: [userId], references: [id])
  event Event? @relation(fields: [eventId], references: [id])

  @@index([userId])
  @@index([eventId])
  @@index([clockIn])
  @@map("time_entries")
}

model Task {
  id                 String       @id @default(uuid())
  title              String       @db.VarChar(200)
  description        String       @db.Text
  clientRequirements String?      @map("client_requirements") @db.Text
  status             TaskStatus   @default(pending)
  priority           TaskPriority @default(medium)
  dueDate            DateTime     @map("due_date") @db.Date
  createdBy          String       @map("created_by")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")

  creator   User           @relation("TaskCreator", fields: [createdBy], references: [id])
  assignees TaskAssignee[]
  comments  Comment[]

  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([createdBy])
  @@map("tasks")
}

model TaskAssignee {
  taskId     String   @map("task_id")
  userId     String   @map("user_id")
  assignedAt DateTime @default(now()) @map("assigned_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([taskId, userId])
  @@map("task_assignees")
}

model Event {
  id               String   @id @default(uuid())
  name             String   @db.VarChar(200)
  description      String   @db.Text
  clientRequirements String? @map("client_requirements") @db.Text
  startDatetime    DateTime @map("start_datetime")
  endDatetime      DateTime @map("end_datetime")
  googleCalendarId String?  @map("google_calendar_id") @db.VarChar(255)
  createdBy        String   @map("created_by")
  createdAt        DateTime @default(now()) @map("created_at")

  creator     User            @relation("EventCreator", fields: [createdBy], references: [id])
  assignees   EventAssignee[]
  timeEntries TimeEntry[]

  @@index([startDatetime])
  @@index([endDatetime])
  @@index([createdBy])
  @@map("events")
}

model EventAssignee {
  eventId String @map("event_id")
  userId  String @map("user_id")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([eventId, userId])
  @@map("event_assignees")
}

model Comment {
  id        String   @id @default(uuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([userId])
  @@map("comments")
}

model WeeklyLog {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  weekStart    DateTime @map("week_start") @db.Date
  weekEnd      DateTime @map("week_end") @db.Date
  activities   String   @db.Text
  achievements String?  @db.Text
  challenges   String?  @db.Text
  learnings    String?  @db.Text
  nextGoals    String?  @map("next_goals") @db.Text
  totalHours   Decimal  @map("total_hours") @db.Decimal(5, 2)
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, weekStart])
  @@index([userId])
  @@index([weekStart])
  @@map("weekly_logs")
}
