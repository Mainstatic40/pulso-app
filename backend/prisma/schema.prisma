generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  supervisor
  becario
}

enum TaskStatus {
  pending
  in_progress
  review
  completed
}

enum TaskPriority {
  high
  medium
  low
}

enum EquipmentCategory {
  camera
  lens
  adapter
  sd_card
}

enum EquipmentStatus {
  available
  in_use
  maintenance
}

model User {
  id           String   @id @default(uuid())
  name         String   @db.VarChar(100)
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  rfidTag      String?  @unique @map("rfid_tag") @db.VarChar(50)
  role         UserRole @default(becario)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  timeEntries            TimeEntry[]
  createdTasks           Task[]                @relation("TaskCreator")
  assignedTasks          TaskAssignee[]
  createdEvents          Event[]               @relation("EventCreator")
  assignedEvents         EventAssignee[]
  comments               Comment[]
  weeklyLogs             WeeklyLog[]
  equipmentAssignments   EquipmentAssignment[] @relation("EquipmentUser")
  createdAssignments     EquipmentAssignment[] @relation("AssignmentCreator")

  @@index([role])
  @@index([isActive])
  @@map("users")
}

model TimeEntry {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  eventId    String?   @map("event_id")
  clockIn    DateTime  @map("clock_in")
  clockOut   DateTime? @map("clock_out")
  totalHours Decimal?  @map("total_hours") @db.Decimal(5, 2)
  createdAt  DateTime  @default(now()) @map("created_at")

  user  User   @relation(fields: [userId], references: [id])
  event Event? @relation(fields: [eventId], references: [id])

  @@index([userId])
  @@index([eventId])
  @@index([clockIn])
  @@map("time_entries")
}

model Task {
  id                 String       @id @default(uuid())
  title              String       @db.VarChar(200)
  description        String       @db.Text
  clientRequirements String?      @map("client_requirements") @db.Text
  status             TaskStatus   @default(pending)
  priority           TaskPriority @default(medium)
  dueDate            DateTime     @map("due_date") @db.Date
  executionDate      DateTime?    @map("execution_date") @db.Date
  shift              String?      @db.VarChar(20)
  morningStartTime   String?      @map("morning_start_time") @db.VarChar(5)
  morningEndTime     String?      @map("morning_end_time") @db.VarChar(5)
  afternoonStartTime String?      @map("afternoon_start_time") @db.VarChar(5)
  afternoonEndTime   String?      @map("afternoon_end_time") @db.VarChar(5)
  createdBy          String       @map("created_by")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")

  creator   User           @relation("TaskCreator", fields: [createdBy], references: [id])
  assignees TaskAssignee[]
  comments  Comment[]

  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([executionDate])
  @@index([createdBy])
  @@map("tasks")
}

model TaskAssignee {
  taskId     String   @map("task_id")
  userId     String   @map("user_id")
  assignedAt DateTime @default(now()) @map("assigned_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([taskId, userId])
  @@map("task_assignees")
}

model Event {
  id                 String   @id @default(uuid())
  name               String   @db.VarChar(200)
  description        String   @db.Text
  clientRequirements String?  @map("client_requirements") @db.Text
  startDatetime      DateTime @map("start_datetime")
  endDatetime        DateTime @map("end_datetime")
  createdBy          String   @map("created_by")
  createdAt          DateTime @default(now()) @map("created_at")

  creator              User                  @relation("EventCreator", fields: [createdBy], references: [id])
  assignees            EventAssignee[]
  timeEntries          TimeEntry[]
  equipmentAssignments EquipmentAssignment[]

  @@index([startDatetime])
  @@index([endDatetime])
  @@index([createdBy])
  @@map("events")
}

model EventAssignee {
  eventId String @map("event_id")
  userId  String @map("user_id")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([eventId, userId])
  @@map("event_assignees")
}

model Comment {
  id        String   @id @default(uuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([userId])
  @@map("comments")
}

model WeeklyLog {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  weekStart    DateTime @map("week_start") @db.Date
  weekEnd      DateTime @map("week_end") @db.Date
  activities   String   @db.Text
  achievements String?  @db.Text
  challenges   String?  @db.Text
  learnings    String?  @db.Text
  nextGoals    String?  @map("next_goals") @db.Text
  totalHours   Decimal  @map("total_hours") @db.Decimal(5, 2)
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, weekStart])
  @@index([userId])
  @@index([weekStart])
  @@map("weekly_logs")
}

model Equipment {
  id           String            @id @default(uuid())
  name         String            @db.VarChar(200)
  category     EquipmentCategory
  status       EquipmentStatus   @default(available)
  description  String?           @db.Text
  serialNumber String?           @map("serial_number") @db.VarChar(100)
  isActive     Boolean           @default(true) @map("is_active")
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")

  assignments EquipmentAssignment[]

  @@index([category])
  @@index([status])
  @@index([isActive])
  @@map("equipment")
}

model EquipmentAssignment {
  id          String    @id @default(uuid())
  equipmentId String    @map("equipment_id")
  userId      String    @map("user_id")
  eventId     String?   @map("event_id")
  startTime   DateTime  @map("start_time")
  endTime     DateTime? @map("end_time")
  notes       String?   @db.Text
  createdBy   String    @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")

  equipment Equipment @relation(fields: [equipmentId], references: [id])
  user      User      @relation("EquipmentUser", fields: [userId], references: [id])
  event     Event?    @relation(fields: [eventId], references: [id])
  creator   User      @relation("AssignmentCreator", fields: [createdBy], references: [id])

  @@index([equipmentId])
  @@index([userId])
  @@index([eventId])
  @@index([startTime])
  @@map("equipment_assignments")
}
